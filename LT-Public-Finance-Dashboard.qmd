---
title: "LT Public Finance Dashboard"
author: "Žygimantas Bogužas"
format: dashboard
embed-resources: true
---

```{r include=FALSE}
#| label: Packages
#| include: false
if(!require("pacman")) install.packages("pacman");library("pacman")
p_load(eurostat, rsdmx, data.table, plotly, janitor, DT)
```

# Centrinė valdžia {orientation="rows"}

## {.tabset}

### Charts {.panel-tabset}
```{r}
#| label: CV data prep
#| include: false

total_variables <- c("Pajamos", "Mokesčiai", "Socialinės įmokos", "Dotacijos_p", "Kitos pajamos",
                     "Išlaidos", "Darbo užmokestis ir socialinis draudimas", "Prekių ir paslaugų naudojimas", "Palūkanos", "Subsidijos", "Dotacijos_i", "Socialinės išmokos", "Kitos išlaidos")

pajamos_vars <- c("Pajamos", "Mokesčiai", "Socialinės įmokos", "Dotacijos_p", "Kitos pajamos")

islaidos_vars <- c("Išlaidos", "Darbo užmokestis ir socialinis draudimas", "Prekių ir paslaugų naudojimas", "Palūkanos", "Subsidijos", "Dotacijos_i", "Socialinės išmokos", "Kitos išlaidos")

dt_CV <- as.data.table(readSDMX(providerId = "LSD", resource = "data", flowRef = "S7R283_M2040105", dsd = TRUE), labels = T)

dt_CV_growth_kv <- dt_CV[, clean_names(dt_CV)
                         ][, kintamasis := fcase(deficitas_m60808 == "R04","Dotacijos_p",
                                                 deficitas_m60808 == "R11","Dotacijos_i",
                                                 deficitas_m60808 == "R21","Vidaus (Grynasis finansinio turto pasikeitimas, išskyrus grynuosius pinigus)",
                                                 deficitas_m60808 == "R22","Užsienio (Grynasis finansinio turto pasikeitimas, išskyrus grynuosius pinigus)",
                                                 deficitas_m60808 == "R24","Vidaus (Grynasis finansinių įsipareigojimų pasikeitimas)",
                                                 deficitas_m60808 == "R25","Užsienio (Grynasis finansinių įsipareigojimų pasikeitimas)",
                                                 rep(TRUE, .N), deficitas_m60808_label_lt)
                           ][, .(laikotarpis, kintamasis, obs_value)
                             ][, laikotarpis := gsub("M", "-", laikotarpis)][, laikotarpis := as.Date(paste0(laikotarpis, "-01"))
                               ][, dcast(.SD, laikotarpis ~ kintamasis, value.var = "obs_value")
                                 ][, paste0(total_variables, "_yoy_growth") := lapply(.SD, function(x) (x/shift(x, n=12, type = "lag"))*100-100), .SDcols = total_variables
                                   ][, paste0(pajamos_vars, "_kv") := lapply(.SD, function(x) (shift(x, n=12, type = "lag")/shift(Pajamos, n=12, type = "lag"))*(x/shift(x, n=12, type = "lag")-1)*100), .SDcols = pajamos_vars
                                     ][, paste0(islaidos_vars, "_kv") := lapply(.SD, function(x) (shift(x, n=12, type = "lag")/shift(Išlaidos, n=12, type = "lag"))*(x/shift(x, n=12, type = "lag")-1)*100), .SDcols = islaidos_vars
                                       ][, clean_names(.SD)]

```

#### Column1 {.tabset}

```{r}
#| label: CV pajamų metinis augimas ir kaitos veiksniai
#| title: CV pajamų metinis augimas ir kaitos veiksniai
#| warning: false
#| padding: 0px

dt_CV_p_kv <- dt_CV_growth_kv[,.(laikotarpis, pajamos_kv, mokesciai_kv, socialines_imokos_kv, dotacijos_p_kv, kitos_pajamos_kv)
                            ][,melt(.SD, measure.vars = 2:ncol(.SD))
                              ][!is.na(value)
                                ][,variable := fcase(variable == "pajamos_kv", "Pajamos",
                                                     variable == "mokesciai_kv", "Mokesčiai",
                                                     variable == "socialines_imokos_kv", "Socialinės įmokos",
                                                     variable == "dotacijos_p_kv", "Dotacijos",
                                                     variable == "kitos_pajamos_kv", "Kitos pajamos")
                                  ][, value := round(value, 1)]
  
plot_ly() |>
  add_trace(data = dt_CV_p_kv[variable != "Pajamos"], x = ~laikotarpis, y = ~value, type = "bar", name = ~variable, color = ~variable) |> 
  layout(barmode = "relative", showlegend = F, xaxis = list(title = "", tickformat= "%Y-%m"), yaxis = list(title="")) |> 
  add_trace(data = dt_CV_p_kv[variable == "Pajamos"], x = ~laikotarpis, y = ~value, type = "scatter", mode = "lines+markers", color = ~variable, line = list(color = "black", width = 3), marker = list(color = "black", size = 8)) |> 
  config(modeBarButtonsToRemove = c("lasso2d", "zoom2d", "zoomIn2d", "zoomOut2d", "select2d", "pan2d", "resetScale2d"), displaylogo = F)
```

```{r}
#| label: CV pajamos nominalia išraiška
#| title: CV pajamos nominalia išraiška
#| warning: false
#| padding: 0px

dt_CV_p_nom <- dt_CV_growth_kv[,.(laikotarpis, pajamos, mokesciai, socialines_imokos, dotacijos_p, kitos_pajamos)
                            ][,melt(.SD, measure.vars = 2:ncol(.SD))
                              ][!is.na(value)
                                ][,variable := fcase(variable == "pajamos", "Pajamos",
                                                     variable == "mokesciai", "Mokesčiai",
                                                     variable == "socialines_imokos", "Socialinės įmokos",
                                                     variable == "dotacijos_p", "Dotacijos",
                                                     variable == "kitos_pajamos", "Kitos pajamos")
                                  ][, value := round(value, 0)]
  
plot_ly() |>
  add_trace(data = dt_CV_p_nom[variable != "Pajamos"], x = ~laikotarpis, y = ~value, type = "bar", name = ~variable, color = ~variable) |> 
  layout(barmode = "relative", showlegend = F, xaxis = list(title = "", tickformat= "%Y-%m", type = "tozero"), yaxis = list(title="")) |> 
  add_trace(data = dt_CV_p_nom[variable == "Pajamos"], x = ~laikotarpis, y = ~value, type = "scatter", mode = "lines+markers", color = ~variable, line = list(color = "black", width = 3), marker = list(color = "black", size = 8)) |> 
  config(modeBarButtonsToRemove = c("lasso2d", "zoom2d", "zoomIn2d", "zoomOut2d", "select2d", "resetScale2d"), displaylogo = F)

```
#### Column2 {.tabset}

```{r}
#| label: CV išlaidų metinis augimas ir kaitos veiksniai
#| title: CV išlaidų metinis augimas ir kaitos veiksniai
#| warning: false
#| padding: 0px

dt_CV_i_kv <- dt_CV_growth_kv[,.(laikotarpis, islaidos_kv, darbo_uzmokestis_ir_socialinis_draudimas_kv, prekiu_ir_paslaugu_naudojimas_kv, palukanos_kv, subsidijos_kv, dotacijos_i_kv, socialines_ismokos_kv, kitos_islaidos_kv)
                            ][,melt(.SD, measure.vars = 2:ncol(.SD))
                              ][!is.na(value)
                                ][,variable := fcase(variable == "islaidos_kv", "Išlaidos",
                                                     variable == "darbo_uzmokestis_ir_socialinis_draudimas_kv", "Darbo užmokestis ir socialinis draudimas",
                                                     variable == "prekiu_ir_paslaugu_naudojimas_kv", "Prekių ir paslaugų naudojimas",
                                                     variable == "palukanos_kv", "Palūkanos",
                                                     variable == "subsidijos_kv", "Subsidijos",
                                                     variable == "dotacijos_i_kv", "Dotacijos",
                                                     variable == "socialines_ismokos_kv", "Socialinės išmokos",
                                                     variable == "kitos_islaidos_kv", "Kitos išlaidos")
                                  ][, value := round(value, 1)]
  
plot_ly() |>
  add_trace(data = dt_CV_i_kv[variable != "Išlaidos"], x = ~laikotarpis, y = ~value, type = "bar", name = ~variable, color = ~variable) |> 
  layout(barmode = "relative", showlegend = F, xaxis = list(title = "", tickformat= "%Y-%m"), yaxis = list(title="")) |> 
  add_trace(data = dt_CV_i_kv[variable == "Išlaidos"], x = ~laikotarpis, y = ~value, type = "scatter", mode = "lines+markers", color = ~variable, line = list(color = "black", width = 3), marker = list(color = "black", size = 8)) |> 
  config(modeBarButtonsToRemove = c("lasso2d", "zoom2d", "zoomIn2d", "zoomOut2d", "select2d", "pan2d", "resetScale2d"), displaylogo = F)

```

```{r}
#| label: CV išlaidos nominalia išraiška
#| title: CV išlaidos nominalia išraiška
#| warning: false
#| padding: 0px

dt_CV_i_nom <- dt_CV_growth_kv[,.(laikotarpis, islaidos, darbo_uzmokestis_ir_socialinis_draudimas, prekiu_ir_paslaugu_naudojimas, palukanos, subsidijos, dotacijos_i, socialines_ismokos, kitos_islaidos)
                            ][,melt(.SD, measure.vars = 2:ncol(.SD))
                              ][!is.na(value)
                                ][,variable := fcase(variable == "islaidos", "Išlaidos",
                                                     variable == "darbo_uzmokestis_ir_socialinis_draudimas", "Darbo užmokestis ir socialinis draudimas",
                                                     variable == "prekiu_ir_paslaugu_naudojimas", "Prekių ir paslaugų naudojimas",
                                                     variable == "palukanos", "Palūkanos",
                                                     variable == "subsidijos", "Subsidijos",
                                                     variable == "dotacijos_i", "Dotacijos",
                                                     variable == "socialines_ismokos", "Socialinės išmokos",
                                                     variable == "kitos_islaidos", "Kitos išlaidos")
                                  ][, value := round(value, 0)]
  
plot_ly() |>
  add_trace(data = dt_CV_i_nom[variable != "Išlaidos"], x = ~laikotarpis, y = ~value, type = "bar", name = ~variable, color = ~variable) |> 
  layout(barmode = "relative", showlegend = F, xaxis = list(title = "", tickformat= "%Y-%m"), yaxis = list(title="")) |> 
  add_trace(data = dt_CV_i_nom[variable == "Išlaidos"], x = ~laikotarpis, y = ~value, type = "scatter", mode = "lines+markers", color = ~variable, line = list(color = "black", width = 3), marker = list(color = "black", size = 8)) |> 
  config(modeBarButtonsToRemove = c("lasso2d", "zoom2d", "zoomIn2d", "zoomOut2d", "select2d", "resetScale2d"), displaylogo = F)

```
### Data
```{r}
#| label: CV Data
#| warning: false
#| padding: 0px

dt_CV_growth_kv[, 2:ncol(dt_CV_growth_kv) := lapply(.SD, round, 1), .SDcols = 2:ncol(dt_CV_growth_kv)
                ][, datatable(data = .SD, rownames = F, filter = "top", extensions = c("Buttons","Scroller"), options = list(dom = "BSltpr", 
                                                                                                 buttons = c("copy","excel","pdf"), 
                                                                                                 autoWidth = TRUE,
                                                                                                 paging = TRUE,
                                                                                                 scroller = TRUE,
                                                                                                 scrollY = 595,
                                                                                                 scrollX = TRUE))]
```
